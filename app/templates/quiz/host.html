{% extends "base.html" %}

{% block title %}Host Quiz - {{ quiz.title }}{% endblock %}

{% block content %}
<div class="host-container">
    <h1>Hosting: {{ quiz.title }}</h1>
    <div class="game-code-box">
        <h2>Game Code:</h2>
        <div class="code-display">{{ code }}</div>
        <button id="copy-code" class="btn btn-primary">Copy Code</button>
    </div>

    <div class="player-list-container">
        <h2>Players</h2>
        <ul id="player-list" class="player-list">
            <!-- Players will be added here via socket.io -->
        </ul>
    </div>

    <button id="start-game" class="btn btn-success">Start Game</button>
    <div id="error-message" class="alert alert-danger" style="display: none;"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Initialize Socket.IO with proper configuration
        const socket = io(window.location.origin, {
            reconnection: true,
            reconnectionAttempts: 5,
            reconnectionDelay: 1000,
            transports: ['websocket', 'polling']
        });
        
        const code = "{{ code }}";
        console.log('Initializing host interface for game:', code);

        // Connection management
        socket.on('connect', () => {
            console.log('Connected to server as host with ID:', socket.id);
            socket.emit('host_join', { code: code });
        });

        socket.on('disconnect', () => {
            console.log('Disconnected from server');
            showError('Connection lost. Attempting to reconnect...');
        });

        socket.on('connect_error', (error) => {
            console.error('Connection error:', error);
            showError('Failed to connect to game server');
        });

        // Player management
        socket.on('player_joined', (data) => {
            console.log('Player joined:', data.username);
            const playerList = document.getElementById('player-list');
            if (playerList) {
                const li = document.createElement('li');
                li.textContent = data.username;
                li.id = `player-${data.username}`;
                playerList.appendChild(li);
            }
        });

        socket.on('player_left', (data) => {
            console.log('Player left:', data.username);
            const playerElement = document.getElementById(`player-${data.username}`);
            if (playerElement) {
                playerElement.remove();
            }
        });

        // Game control
        const startGameBtn = document.getElementById('start-game');
        if (startGameBtn) {
            startGameBtn.addEventListener('click', () => {
                console.log('Starting game with code:', code);
                socket.emit('start_game', { code: code });
            });
        }

        // Copy code functionality
        const copyCodeBtn = document.getElementById('copy-code');
        if (copyCodeBtn) {
            copyCodeBtn.addEventListener('click', () => {
                navigator.clipboard.writeText(code).then(() => {
                    const alert = document.createElement('div');
                    alert.className = 'alert alert-success';
                    alert.textContent = 'Game code copied to clipboard!';
                    document.body.appendChild(alert);
                    setTimeout(() => alert.remove(), 3000);
                }).catch(err => {
                    console.error('Failed to copy:', err);
                    showError('Failed to copy code');
                });
            });
        }

        // Game state handling
        socket.on('game_started', (data) => {
            console.log('Game started response:', data);
            if (data.status === 'success') {
                window.location.href = `/quiz/play/${code}/host`;
            } else {
                showError(data.message || 'Failed to start game');
            }
        });

        // Error handling
        socket.on('error', (data) => {
            console.error('Socket error:', data.message);
            showError(data.message || 'An error occurred');
        });

        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
        }
    });
</script>
{% endblock %}